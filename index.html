import React, { useMemo, useState } from 'react';

/**
 * GoComet - US Import Tariff Calculator
 * Fixes in this revision:
 * - Replaced `catch {}` with `catch (err) {}` for ES2015- compatibility.
 * - Removed stray, corrupted code after `fmtPct` that caused a syntax error.
 * - Corrected JSX closing tags around the results section (removed extra braces/sections).
 * - Kept existing tests and added more lightweight console.assert tests.
 */

const WEBHOOK_URL = 'https://n8n.product-internal.gocomet.com/webhook-test/6dc1904d-24c5-4c08-a042-882af95440cb';
const REQUEST_TIMEOUT_MS = 90000; // 90s
const UPSTREAM_WEBHOOK = WEBHOOK_URL; // cross-origin upstream
const DEFAULT_PROXY_ENDPOINT = '/api/tariff'; // same-origin proxy endpoint

// --- Local SVG Icons (no external deps) ---
function IconChevronDown({ className = '' }) {
  return (
    <svg
      className={className}
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      role="presentation"
      aria-hidden="true"
      focusable="false"
    >
      <polyline points="6 9 12 15 18 9" />
    </svg>
  );
}

function IconLoader({ className = '' }) {
  return (
    <svg
      className={className}
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      role="presentation"
      aria-hidden="true"
      focusable="false"
    >
      <line x1="12" y1="2" x2="12" y2="6" />
      <line x1="12" y1="18" x2="12" y2="22" />
      <line x1="4.93" y1="4.93" x2="7.76" y2="7.76" />
      <line x1="16.24" y1="16.24" x2="19.07" y2="19.07" />
      <line x1="2" y1="12" x2="6" y2="12" />
      <line x1="18" y1="12" x2="22" y2="12" />
      <line x1="4.93" y1="19.07" x2="7.76" y2="16.24" />
      <line x1="16.24" y1="7.76" x2="19.07" y2="4.93" />
    </svg>
  );
}

// --- Helpers ---
function normalizeHts(input) {
  if (!input) return '';
  const digits = String(input).replace(/\D/g, '').slice(0, 10);
  return digits;
}

function formatHtsDotted(digits10) {
  if (!/^\d{10}$/.test(digits10)) return '';
  return `${digits10.slice(0, 4)}.${digits10.slice(4, 6)}.${digits10.slice(6, 8)}.${digits10.slice(8, 10)}`;
}

// --- Parsing & formatting helpers for results ---
function parsePercent(s) {
  if (s == null) return 0;
  const m = String(s).match(/-?\d+(?:\.\d+)?/);
  return m ? parseFloat(m[0]) : 0;
}
function parseMoney(s) {
  if (s == null) return 0;
  const n = parseFloat(String(s).replace(/[^0-9.-]/g, ''));
  return isNaN(n) ? 0 : n;
}
const fmtUSD = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(Number(n || 0));
const fmtPct = (n) => `${Number(n || 0).toFixed(2)}%`;

// --- Dev-time assertions (simple tests) ---
if (typeof window !== 'undefined') {
  try {
    console.assert(normalizeHts('0102.39.00.54') === '0102390054', 'normalizeHts dotted failed');
    console.assert(normalizeHts('0102390054') === '0102390054', 'normalizeHts plain failed');
    console.assert(formatHtsDotted('0102390054') === '0102.39.00.54', 'formatHtsDotted failed');
    // more tests (added)
    console.assert(normalizeHts(' 0102-39-00-54 ') === '0102390054', 'normalizeHts punctuation failed');
    console.assert(normalizeHts('0102390054999') === '0102390054', 'normalizeHts length cap failed');
    console.assert(formatHtsDotted('1234567890') === '1234.56.78.90', 'formatHtsDotted pattern failed');
    // additional tests
    console.assert(normalizeHts('') === '', 'normalizeHts empty failed');
    console.assert(normalizeHts('abc') === '', 'normalizeHts nondigits failed');
    console.assert(formatHtsDotted('0000000000') === '0000.00.00.00', 'formatHtsDotted zeros failed');
    console.assert(formatHtsDotted('123456789') === '', 'formatHtsDotted short input should be empty');
    // parsing helpers tests
    console.assert(parsePercent('5%') === 5, 'parsePercent with % failed');
    console.assert(parsePercent('2.75 percent') === 2.75, 'parsePercent decimal failed');
    console.assert(parseMoney('$1,234.56') === 1234.56, 'parseMoney currency failed');
    console.assert(fmtPct(3.5) === '3.50%', 'fmtPct formatting failed');
  } catch (err) { /* no-op */ }
}

// --- Country list (from user) ---
const countries = [
  { name: 'Afghanistan', flag: 'ğŸ‡¦ğŸ‡«' },
  { name: 'Albania', flag: 'ğŸ‡¦ğŸ‡±' },
  { name: 'Algeria', flag: 'ğŸ‡©ğŸ‡¿' },
  { name: 'Andorra', flag: 'ğŸ‡¦ğŸ‡©' },
  { name: 'Angola', flag: 'ğŸ‡¦ğŸ‡´' },
  { name: 'Anguilla', flag: 'ğŸ‡¦ğŸ‡®' },
  { name: 'Antigua and Barbuda', flag: 'ğŸ‡¦ğŸ‡¬' },
  { name: 'Argentina', flag: 'ğŸ‡¦ğŸ‡·' },
  { name: 'Armenia', flag: 'ğŸ‡¦ğŸ‡²' },
  { name: 'Aruba', flag: 'ğŸ‡¦ğŸ‡¼' },
  { name: 'Australia', flag: 'ğŸ‡¦ğŸ‡º' },
  { name: 'Azerbaijan', flag: 'ğŸ‡¦ğŸ‡¿' },
  { name: 'Bahamas', flag: 'ğŸ‡§ğŸ‡¸' },
  { name: 'Bahrain', flag: 'ğŸ‡§ğŸ‡­' },
  { name: 'Bangladesh', flag: 'ğŸ‡§ğŸ‡©' },
  { name: 'Barbados', flag: 'ğŸ‡§ğŸ‡§' },
  { name: 'Belize', flag: 'ğŸ‡§ğŸ‡¿' },
  { name: 'Benin', flag: 'ğŸ‡§ğŸ‡¯' },
  { name: 'Bermuda', flag: 'ğŸ‡§ğŸ‡²' },
  { name: 'Bhutan', flag: 'ğŸ‡§ğŸ‡¹' },
  { name: 'Bolivia', flag: 'ğŸ‡§ğŸ‡´' },
  { name: 'Bosnia and Herzegovina', flag: 'ğŸ‡§ğŸ‡¦' },
  { name: 'Botswana', flag: 'ğŸ‡§ğŸ‡¼' },
  { name: 'Brazil', flag: 'ğŸ‡§ğŸ‡·' },
  { name: 'British Indian Ocean Territory', flag: 'ğŸ‡®ğŸ‡´' },
  { name: 'British Virgin Islands', flag: 'ğŸ‡»ğŸ‡¬' },
  { name: 'Brunei', flag: 'ğŸ‡§ğŸ‡³' },
  { name: 'Burundi', flag: 'ğŸ‡§ğŸ‡®' },
  { name: 'Cabo Verde', flag: 'ğŸ‡¨ğŸ‡»' },
  { name: 'Cambodia', flag: 'ğŸ‡°ğŸ‡­' },
  { name: 'Cameroon', flag: 'ğŸ‡¨ğŸ‡²' },
  { name: 'Cayman Islands', flag: 'ğŸ‡°ğŸ‡¾' },
  { name: 'Central African Republic', flag: 'ğŸ‡¨ğŸ‡«' },
  { name: 'Chad', flag: 'ğŸ‡¹ğŸ‡©' },
  { name: 'Chile', flag: 'ğŸ‡¨ğŸ‡±' },
  { name: 'China', flag: 'ğŸ‡¨ğŸ‡³' },
  { name: 'Christmas Island', flag: 'ğŸ‡¨ğŸ‡½' },
  { name: 'Cocos (Keeling) Islands', flag: 'ğŸ‡¨ğŸ‡¨' },
  { name: 'Colombia', flag: 'ğŸ‡¨ğŸ‡´' },
  { name: 'Comoros', flag: 'ğŸ‡°ğŸ‡²' },
  { name: 'Cook Islands', flag: 'ğŸ‡¨ğŸ‡°' },
  { name: 'Costa Rica', flag: 'ğŸ‡¨ğŸ‡·' },
  { name: 'CÃ´te d\u2019Ivoire', flag: 'ğŸ‡¨ğŸ‡®' },
  { name: 'CuraÃ§ao', flag: 'ğŸ‡¨ğŸ‡¼' },
  { name: 'Democratic Republic of the Congo', flag: 'ğŸ‡¨ğŸ‡©' },
  { name: 'Djibouti', flag: 'ğŸ‡©ğŸ‡¯' },
  { name: 'Dominica', flag: 'ğŸ‡©ğŸ‡²' },
  { name: 'Dominican Republic', flag: 'ğŸ‡©ğŸ‡´' },
  { name: 'Ecuador', flag: 'ğŸ‡ªğŸ‡¨' },
  { name: 'Egypt', flag: 'ğŸ‡ªğŸ‡¬' },
  { name: 'El Salvador', flag: 'ğŸ‡¸ğŸ‡»' },
  { name: 'Equatorial Guinea', flag: 'ğŸ‡¬ğŸ‡¶' },
  { name: 'Eritrea', flag: 'ğŸ‡ªğŸ‡·' },
  { name: 'Eswatini', flag: 'ğŸ‡¸ğŸ‡¿' },
  { name: 'Ethiopia', flag: 'ğŸ‡ªğŸ‡¹' },
  { name: 'European Union', flag: 'ğŸ‡ªğŸ‡º' },
  { name: 'Falkland Islands', flag: 'ğŸ‡«ğŸ‡°' },
  { name: 'Fiji', flag: 'ğŸ‡«ğŸ‡¯' },
  { name: 'Finland', flag: 'ğŸ‡«ğŸ‡®' },
  { name: 'French Guiana', flag: 'ğŸ‡¬ğŸ‡«' },
  { name: 'French Polynesia', flag: 'ğŸ‡µğŸ‡«' },
  { name: 'Gabon', flag: 'ğŸ‡¬ğŸ‡¦' },
  { name: 'Gambia', flag: 'ğŸ‡¬ğŸ‡²' },
  { name: 'Georgia', flag: 'ğŸ‡¬ğŸ‡ª' },
  { name: 'Ghana', flag: 'ğŸ‡¬ğŸ‡­' },
  { name: 'Gibraltar', flag: 'ğŸ‡¬ğŸ‡®' },
  { name: 'Grenada', flag: 'ğŸ‡¬ğŸ‡©' },
  { name: 'Guadeloupe', flag: 'ğŸ‡¬ğŸ‡µ' },
  { name: 'Guatemala', flag: 'ğŸ‡¬ğŸ‡¹' },
  { name: 'Guinea', flag: 'ğŸ‡¬ğŸ‡³' },
  { name: 'Guinea-Bissau', flag: 'ğŸ‡¬ğŸ‡¼' },
  { name: 'Guyana', flag: 'ğŸ‡¬ğŸ‡¾' },
  { name: 'Haiti', flag: 'ğŸ‡­ğŸ‡¹' },
  { name: 'Heard and McDonald Islands', flag: 'ğŸ‡­ğŸ‡²' },
  { name: 'Honduras', flag: 'ğŸ‡­ğŸ‡³' },
  { name: 'Iceland', flag: 'ğŸ‡®ğŸ‡¸' },
  { name: 'India', flag: 'ğŸ‡®ğŸ‡³' },
  { name: 'Indonesia', flag: 'ğŸ‡®ğŸ‡©' },
  { name: 'Iran', flag: 'ğŸ‡®ğŸ‡·' },
  { name: 'Iraq', flag: 'ğŸ‡®ğŸ‡¶' },
  { name: 'Israel', flag: 'ğŸ‡®ğŸ‡±' },
  { name: 'Jamaica', flag: 'ğŸ‡¯ğŸ‡²' },
  { name: 'Japan', flag: 'ğŸ‡¯ğŸ‡µ' },
  { name: 'Jordan', flag: 'ğŸ‡¯ğŸ‡´' },
  { name: 'Kazakhstan', flag: 'ğŸ‡°ğŸ‡¿' },
  { name: 'Kenya', flag: 'ğŸ‡°ğŸ‡ª' },
  { name: 'Kiribati', flag: 'ğŸ‡°ğŸ‡®' },
  { name: 'Kosovo', flag: 'ğŸ‡½ğŸ‡°' },
  { name: 'Kuwait', flag: 'ğŸ‡°ğŸ‡¼' },
  { name: 'Kyrgyzstan', flag: 'ğŸ‡°ğŸ‡¬' },
  { name: 'Laos', flag: 'ğŸ‡±ğŸ‡¦' },
  { name: 'Lebanon', flag: 'ğŸ‡±ğŸ‡§' },
  { name: 'Lesotho', flag: 'ğŸ‡±ğŸ‡¸' },
  { name: 'Liberia', flag: 'ğŸ‡±ğŸ‡·' },
  { name: 'Libya', flag: 'ğŸ‡±ğŸ‡¾' },
  { name: 'Liechtenstein', flag: 'ğŸ‡±ğŸ‡®' },
  { name: 'Madagascar', flag: 'ğŸ‡²ğŸ‡¬' },
  { name: 'Malawi', flag: 'ğŸ‡²ğŸ‡¼' },
  { name: 'Malaysia', flag: 'ğŸ‡²ğŸ‡¾' },
  { name: 'Maldives', flag: 'ğŸ‡²ğŸ‡»' },
  { name: 'Mali', flag: 'ğŸ‡²ğŸ‡±' },
  { name: 'Marshall Islands', flag: 'ğŸ‡²ğŸ‡­' },
  { name: 'Martinique', flag: 'ğŸ‡²ğŸ‡¶' },
  { name: 'Mauritania', flag: 'ğŸ‡²ğŸ‡·' },
  { name: 'Mauritius', flag: 'ğŸ‡²ğŸ‡º' },
  { name: 'Mayotte', flag: 'ğŸ‡¾ğŸ‡¹' },
  { name: 'Micronesia', flag: 'ğŸ‡«ğŸ‡²' },
  { name: 'Moldova', flag: 'ğŸ‡²ğŸ‡©' },
  { name: 'Monaco', flag: 'ğŸ‡²ğŸ‡¨' },
  { name: 'Mongolia', flag: 'ğŸ‡²ğŸ‡³' },
  { name: 'Montenegro', flag: 'ğŸ‡²ğŸ‡ª' },
  { name: 'Montserrat', flag: 'ğŸ‡²ğŸ‡¸' },
  { name: 'Morocco', flag: 'ğŸ‡²ğŸ‡¦' },
  { name: 'Mozambique', flag: 'ğŸ‡²ğŸ‡¿' },
  { name: 'Myanmar', flag: 'ğŸ‡²ğŸ‡²' },
  { name: 'Namibia', flag: 'ğŸ‡³ğŸ‡¦' },
  { name: 'Nauru', flag: 'ğŸ‡³ğŸ‡·' },
  { name: 'Nepal', flag: 'ğŸ‡³ğŸ‡µ' },
  { name: 'New Zealand', flag: 'ğŸ‡³ğŸ‡¿' },
  { name: 'Nicaragua', flag: 'ğŸ‡³ğŸ‡®' },
  { name: 'Niger', flag: 'ğŸ‡³ğŸ‡ª' },
  { name: 'Nigeria', flag: 'ğŸ‡³ğŸ‡¬' },
  { name: 'Norfolk Island', flag: 'ğŸ‡³ğŸ‡«' },
  { name: 'North Macedonia', flag: 'ğŸ‡²ğŸ‡°' },
  { name: 'Norway', flag: 'ğŸ‡³ğŸ‡´' },
  { name: 'Oman', flag: 'ğŸ‡´ğŸ‡²' },
  { name: 'Pakistan', flag: 'ğŸ‡µğŸ‡°' },
  { name: 'Panama', flag: 'ğŸ‡µğŸ‡¦' },
  { name: 'Papua New Guinea', flag: 'ğŸ‡µğŸ‡¬' },
  { name: 'Paraguay', flag: 'ğŸ‡µğŸ‡¾' },
  { name: 'Peru', flag: 'ğŸ‡µğŸ‡ª' },
  { name: 'Philippines', flag: 'ğŸ‡µğŸ‡­' },
  { name: 'Qatar', flag: 'ğŸ‡¶ğŸ‡¦' },
  { name: 'Republic of the Congo', flag: 'ğŸ‡¨ğŸ‡¬' },
  { name: 'Reunion', flag: 'ğŸ‡·ğŸ‡ª' },
  { name: 'Rwanda', flag: 'ğŸ‡·ğŸ‡¼' },
  { name: 'Saint Helena', flag: 'ğŸ‡¸ğŸ‡­' },
  { name: 'Saint Kitts and Nevis', flag: 'ğŸ‡°ğŸ‡³' },
  { name: 'Saint Lucia', flag: 'ğŸ‡±ğŸ‡¨' },
  { name: 'Saint Pierre and Miquelon', flag: 'ğŸ‡µğŸ‡²' },
  { name: 'Saint Vincent and the Grenadines', flag: 'ğŸ‡»ğŸ‡¨' },
  { name: 'Samoa', flag: 'ğŸ‡¼ğŸ‡¸' },
  { name: 'San Marino', flag: 'ğŸ‡¸ğŸ‡²' },
  { name: 'SÃ£o TomÃ© and PrÃ­ncipe', flag: 'ğŸ‡¸ğŸ‡¹' },
  { name: 'Saudi Arabia', flag: 'ğŸ‡¸ğŸ‡¦' },
  { name: 'Senegal', flag: 'ğŸ‡¸ğŸ‡³' },
  { name: 'Serbia', flag: 'ğŸ‡·ğŸ‡¸' },
  { name: 'Sierra Leone', flag: 'ğŸ‡¸ğŸ‡±' },
  { name: 'Singapore', flag: 'ğŸ‡¸ğŸ‡¬' },
  { name: 'Sint Maarten', flag: 'ğŸ‡¸ğŸ‡½' },
  { name: 'Solomon Islands', flag: 'ğŸ‡¸ğŸ‡§' },
  { name: 'South Africa', flag: 'ğŸ‡¿ğŸ‡¦' },
  { name: 'South Korea', flag: 'ğŸ‡°ğŸ‡·' },
  { name: 'South Sudan', flag: 'ğŸ‡¸ğŸ‡¸' },
  { name: 'Sri Lanka', flag: 'ğŸ‡±ğŸ‡°' },
  { name: 'Sudan', flag: 'ğŸ‡¸ğŸ‡©' },
  { name: 'Suriname', flag: 'ğŸ‡¸ğŸ‡·' },
  { name: 'Svalbard and Jan Mayen', flag: 'ğŸ‡¸ğŸ‡¯' },
  { name: 'Switzerland', flag: 'ğŸ‡¨ğŸ‡­' },
  { name: 'Syria', flag: 'ğŸ‡¸ğŸ‡¾' },
  { name: 'Taiwan', flag: 'ğŸ‡¹ğŸ‡¼' },
  { name: 'Tajikistan', flag: 'ğŸ‡¹ğŸ‡¯' },
  { name: 'Tanzania', flag: 'ğŸ‡¹ğŸ‡¿' },
  { name: 'Thailand', flag: 'ğŸ‡¹ğŸ‡­' },
  { name: 'Timor-Leste', flag: 'ğŸ‡¹ğŸ‡±' },
  { name: 'Togo', flag: 'ğŸ‡¹ğŸ‡¬' },
  { name: 'Tokelau', flag: 'ğŸ‡¹ğŸ‡°' },
  { name: 'Tonga', flag: 'ğŸ‡¹ğŸ‡´' },
  { name: 'Trinidad and Tobago', flag: 'ğŸ‡¹ğŸ‡¹' },
  { name: 'Tunisia', flag: 'ğŸ‡¹ğŸ‡³' },
  { name: 'Turkey', flag: 'ğŸ‡¹ğŸ‡·' },
  { name: 'Turkmenistan', flag: 'ğŸ‡¹ğŸ‡²' },
  { name: 'Turks and Caicos Islands', flag: 'ğŸ‡¹ğŸ‡¨' },
  { name: 'Tuvalu', flag: 'ğŸ‡¹ğŸ‡»' },
  { name: 'Uganda', flag: 'ğŸ‡ºğŸ‡¬' },
  { name: 'Ukraine', flag: 'ğŸ‡ºğŸ‡¦' },
  { name: 'United Arab Emirates', flag: 'ğŸ‡¦ğŸ‡ª' },
  { name: 'United Kingdom', flag: 'ğŸ‡¬ğŸ‡§' },
  { name: 'Uruguay', flag: 'ğŸ‡ºğŸ‡¾' },
  { name: 'Uzbekistan', flag: 'ğŸ‡ºğŸ‡¿' },
  { name: 'Vanuatu', flag: 'ğŸ‡»ğŸ‡º' },
  { name: 'Venezuela', flag: 'ğŸ‡»ğŸ‡ª' },
  { name: 'Vietnam', flag: 'ğŸ‡»ğŸ‡³' },
  { name: 'Yemen', flag: 'ğŸ‡¾ğŸ‡ª' },
  { name: 'Zambia', flag: 'ğŸ‡¿ğŸ‡²' },
  { name: 'Zimbabwe', flag: 'ğŸ‡¿ğŸ‡¼' },
];

// --- FAQs ---
const faqs = [
  {
    question: 'What is an HTS Code?',
    answer: 'A 10-digit US classification used to determine duties. Format can be dotted (0000.00.00.00) or 10 continuous digits.'
  },
  {
    question: 'Which inputs affect duties?',
    answer: 'HTS code, country of origin, date of entry, shipment value, and special programs (e.g., Section 301, 232, IEEPA, 201).'
  },
  {
    question: 'Why might my request fail to send?',
    answer: 'If the webhook origin lacks CORS headers, the browser will block the request. Use the Debug button to run diagnostics and check the console.'
  },
  {
    question: 'What will I see in results?',
    answer: 'A breakdown returned by the engine (e.g., base rate, reciprocal/retaliatory duties) rendered as key/value cards.'
  }
];

export default function GocometTariffCalculator() {
  const [formData, setFormData] = useState({
    htsCode: '',
    countryOfOrigin: 'China',
    dateOfEntry: '',
    shipmentValue: ''
  });
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [openFaq, setOpenFaq] = useState(null);
  const [error, setError] = useState(null);
  const [submitInfo, setSubmitInfo] = useState(null);
  const [results, setResults] = useState(null);
  const [diag, setDiag] = useState(null); // visible diagnostics
  const [simpleMode, setSimpleMode] = useState(false); // optional simple request (text/plain) to test preflight avoidance
  const [useProxy, setUseProxy] = useState(true); // prefer same-origin proxy by default
  const [endpoint, setEndpoint] = useState(() => {
    try { return localStorage.getItem('tariff_endpoint') || DEFAULT_PROXY_ENDPOINT; } catch (err) { return DEFAULT_PROXY_ENDPOINT; }
  });

  const today = useMemo(() => new Date().toISOString().slice(0, 10), []);
  const htsDigits = useMemo(() => normalizeHts(formData.htsCode), [formData.htsCode]);
  const htsPretty = useMemo(() => formatHtsDotted(htsDigits), [htsDigits]);

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setError(null); setSubmitInfo(null); setResults(null);
    setFormData((prev) => ({ ...prev, [name]: value }));
  };

  function validate() {
    if (!htsDigits || htsDigits.length !== 10) return 'Please enter a valid 10-digit HTS (e.g., 0102390054 or 0102.39.00.54).';
    if (!formData.countryOfOrigin) return 'Please select a country of origin.';
    if (!formData.dateOfEntry) return 'Please choose a date of entry.';
    if (formData.dateOfEntry > today) return 'Date of entry cannot be in the future.';
    const val = Number(formData.shipmentValue);
    if (!(val > 0)) return 'Shipment value must be greater than 0.';
    return null;
  }

  async function handleSubmit(e) {
    e.preventDefault();
    setError(null); setSubmitInfo(null); setResults(null);

    const err = validate();
    if (err) { setError(err); return; }
    setIsSubmitting(true);

    const payload = [{
      '10 Digit HTS CODE': htsDigits,
      'Country of Origin ': formData.countryOfOrigin,
      'Date Of entry': formData.dateOfEntry,
      'Shipment value': Number(formData.shipmentValue),
      submittedAt: new Date().toISOString(),
      formMode: 'webform'
    }];

    console.info('[TariffCalculator] POST payload â†’', payload);

    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), REQUEST_TIMEOUT_MS);

    try {
      const fetchInit = simpleMode
        ? { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload), signal: controller.signal, referrerPolicy: 'no-referrer' }
        : { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload), signal: controller.signal, referrerPolicy: 'no-referrer' };

      const res = await fetch(endpoint, fetchInit);
      clearTimeout(timeout);

      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(text || `Webhook error (HTTP ${res.status})`);
        }

      const txt = await res.text();
      let data; try { data = txt ? JSON.parse(txt) : []; } catch (err) { data = txt ? [{ Raw: txt }] : []; }

      if (!Array.isArray(data) || data.length === 0) {
        setSubmitInfo({ type: 'success', message: 'Submitted. No rows returned.' });
      } else {
        setResults(data);
        setSubmitInfo({ type: 'success', message: 'Tariff calculation completed.' });
      }
    } catch (err2) {
      let msg = 'Unable to reach the webhook. ';
      if (err2?.name === 'AbortError') msg += 'Request timed out.';
      else if (String(err2).includes('Failed to fetch') || String(err2).includes('NetworkError')) msg += 'Possible CORS block on the server or network issue.';
      else msg += String(err2.message || err2);
      setError(msg + ' Use the Debug button below for details.');
      console.error('[TariffCalculator] fetch error â†’', err2);
    } finally {
      setIsSubmitting(false);
      clearTimeout(timeout);
    }
  }

  async function runDiagnostics() {
    const out = { origin: window.location.origin, url: endpoint, upstream: UPSTREAM_WEBHOOK, time: new Date().toISOString() };

    try {
      const r = await fetch(endpoint, { method: 'GET', mode: 'cors' });
      out.getStatus = `${r.status}`; out.getACAO = r.headers?.get?.('access-control-allow-origin') || null;
    } catch (e) { out.getError = String(e); }

    try {
      const r2 = await fetch(endpoint, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain' }, body: 'ping' });
      out.postSimpleStatus = `${r2.status}`; out.postSimpleACAO = r2.headers?.get?.('access-control-allow-origin') || null;
    } catch (e2) { out.postSimpleError = String(e2); }

    try {
      const r3 = await fetch(endpoint, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: '[{"diag":"preflight"}]' });
      out.postJsonStatus = `${r3.status}`; out.postJsonACAO = r3.headers?.get?.('access-control-allow-origin') || null;
    } catch (e3) { out.postJsonError = String(e3); }

    out.curl = `curl -X POST '${UPSTREAM_WEBHOOK}' \
  -H 'Content-Type: application/json' \
  --data '[{"10 Digit HTS CODE":"${htsDigits || '0102390054'}","Country of Origin ":"${formData.countryOfOrigin}","Date Of entry":"${formData.dateOfEntry || '2025-01-01'}","Shipment value":${Number(formData.shipmentValue) || 1000}}]'`;

    console.table(out);
    setDiag(out);
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Fullscreen calculating overlay */}
      {isSubmitting && (
        <div className="fixed inset-0 z-50 bg-white/80 backdrop-blur-sm flex flex-col items-center justify-center">
          <div className="relative w-32 h-32">
            <div className="absolute w-6 h-6 rounded-full bg-blue-600 animate-ping"></div>
            <div className="absolute left-6 top-6 w-20 h-2 rounded-full bg-blue-300 animate-[pulse_1.2s_ease-in-out_infinite]"></div>
          </div>
          <div className="w-64 h-2 bg-gray-200 rounded mt-6 overflow-hidden">
            <div className="h-full w-1/3 bg-blue-600 animate-[progress_1.8s_ease-in-out_infinite]"></div>
          </div>
          <p className="mt-4 text-sm text-gray-700">Calculating dutiesâ€¦</p>
          <style>{`
            @keyframes progress { 0% { transform: translateX(-100%); } 50% { transform: translateX(20%); } 100% { transform: translateX(120%); } }
          `}</style>
        </div>
      )}

      {/* Header */}
      <header className="bg-white shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center">
              <svg width="140" height="32" viewBox="0 0 140 32" fill="none" aria-label="GoComet" xmlns="http://www.w3.org/2000/svg">
                <text x="0" y="24" style={{ fontFamily: 'Arial, sans-serif', fontSize: '20px', fontWeight: 'bold' }}>
                  <tspan fill="#0066FF">GO</tspan>
                  <tspan fill="#1a2332">COMET</tspan>
                </text>
              </svg>
            </div>

            <nav className="hidden md:flex space-x-8">
              <button className="text-gray-700 hover:text-gray-900 flex items-center">Platform <IconChevronDown className="ml-1 w-4 h-4" /></button>
              <button className="text-gray-700 hover:text-gray-900 flex items-center">Solutions <IconChevronDown className="ml-1 w-4 h-4" /></button>
              <button className="text-gray-700 hover:text-gray-900 flex items-center">Market Intelligence <IconChevronDown className="ml-1 w-4 h-4" /></button>
              <button className="text-gray-700 hover:text-gray-900 flex items-center">Insights <IconChevronDown className="ml-1 w-4 h-4" /></button>
              <button className="text-gray-700 hover:text-gray-900 flex items-center">Company <IconChevronDown className="ml-1 w-4 h-4" /></button>
            </nav>

            <div className="flex items-center space-x-4">
              <button className="text-blue-600 hover:text-blue-700 font-medium">Sign In</button>
              <button className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">Get a Demo</button>
            </div>
          </div>
        </div>
      </header>

      {/* Hero */}
      <section className="bg-gradient-to-r from-blue-900 to-blue-700 text-white py-16">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
          <h1 className="text-4xl md:text-5xl font-bold mb-4">US Import Tariff Calculator</h1>
          <p className="text-lg md:text-xl text-blue-100 max-w-3xl mx-auto">Calculate estimated US import duties by HTS code, country of origin, and entry dateâ€”complete with special programs.</p>
        </div>
      </section>

      {/* Calculator Form */}
      <main className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 -mt-8">
        <div className="bg-white rounded-lg shadow-lg p-8">
          <form onSubmit={handleSubmit}>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">HTS Code <span className="text-red-500">*</span></label>
                <input type="text" name="htsCode" value={formData.htsCode} onChange={handleInputChange} placeholder="0102.39.00.54 or 0102390054" className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                {htsPretty && (<p className="mt-1 text-xs text-gray-500">Normalized: {htsPretty}</p>)}
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Country of Origin <span className="text-red-500">*</span></label>
                <select name="countryOfOrigin" value={formData.countryOfOrigin} onChange={handleInputChange} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none">
                  {countries.map((c) => (<option key={c.name} value={c.name}>{c.flag} {c.name}</option>))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Date of Entry <span className="text-red-500">*</span></label>
                <input type="date" name="dateOfEntry" value={formData.dateOfEntry} onChange={handleInputChange} max={today} className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Shipment Value (USD) <span className="text-red-500">*</span></label>
                <div className="relative">
                  <span className="absolute left-4 top-2.5 text-gray-500">$</span>
                  <input type="number" name="shipmentValue" value={formData.shipmentValue} onChange={handleInputChange} placeholder="1000.00" min="0" step="0.01" className="w-full pl-8 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
                </div>
              </div>
            </div>

            {/* Controls + Actions */}
            <div className="mt-8 flex flex-col items-center justify-center gap-3">
              <div className="w-full max-w-2xl grid gap-2">
                <label className="flex items-center gap-2 text-sm text-gray-700">
                  <input
                    type="checkbox"
                    checked={useProxy}
                    onChange={(e) => {
                      const next = e.target.checked;
                      setUseProxy(next);
                      const nextEndpoint = next ? DEFAULT_PROXY_ENDPOINT : UPSTREAM_WEBHOOK;
                      setEndpoint(nextEndpoint);
                      try { localStorage.setItem('tariff_endpoint', nextEndpoint); } catch (err) {}
                    }}
                  />
                  Use same-origin proxy ({DEFAULT_PROXY_ENDPOINT}) to bypass CORS
                </label>
                <div className="text-xs text-gray-500">If disabled, the app calls the upstream webhook directly (requires CORS headers on the upstream).</div>
                <label className="text-sm text-gray-700">Active Endpoint</label>
                <input
                  type="url"
                  value={endpoint}
                  onChange={(e) => { setEndpoint(e.target.value); try { localStorage.setItem('tariff_endpoint', e.target.value); } catch (err) {} }}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                  placeholder={useProxy ? DEFAULT_PROXY_ENDPOINT : UPSTREAM_WEBHOOK}
                />
              </div>

              <div className="flex items-center gap-3">
                <button type="submit" disabled={isSubmitting} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium text-lg disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center">
                  {isSubmitting ? (<><IconLoader className="mr-2 h-5 w-5 animate-spin" />Calculatingâ€¦</>) : ('Calculate Tariff')}
                </button>
                <button type="button" onClick={runDiagnostics} className="text-sm text-blue-700 hover:text-blue-800 underline">Debug</button>
              </div>
              <label className="mt-2 flex items-center gap-2 text-sm text-gray-600">
                <input type="checkbox" checked={simpleMode} onChange={(e) => setSimpleMode(e.target.checked)} />
                Use simple POST (text/plain) to avoid preflight (for direct upstream calls)
              </label>
            </div>

            {submitInfo && (<div className="mt-4 text-center text-green-700 text-sm">{submitInfo.message}</div>)}
            {diag && (
              <div className="mt-4 p-4 rounded-lg bg-gray-50 border text-sm text-gray-800">
                <div className="font-semibold mb-2">Debug Output</div>
                <div className="grid md:grid-cols-2 gap-3">
                  <div>
                    <div><span className="font-mono">origin</span>: {diag.origin}</div>
                    <div><span className="font-mono">url</span>: {diag.url}</div>
                    <div><span className="font-mono">upstream</span>: {diag.upstream}</div>
                    <div><span className="font-mono">time</span>: {diag.time}</div>
                  </div>
                  <div>
                    <div><span className="font-mono">GET</span>: {diag.getStatus || diag.getError || 'â€”'} {diag.getACAO ? `(ACAO: ${diag.getACAO})` : ''}</div>
                    <div><span className="font-mono">POST text/plain</span>: {diag.postSimpleStatus || diag.postSimpleError || 'â€”'} {diag.postSimpleACAO ? `(ACAO: ${diag.postSimpleACAO})` : ''}</div>
                    <div><span className="font-mono">POST application/json</span>: {diag.postJsonStatus || diag.postJsonError || 'â€”'} {diag.postJsonACAO ? `(ACAO: ${diag.postJsonACAO})` : ''}</div>
                  </div>
                </div>
                <div className="mt-3">
                  <div className="font-semibold mb-1">cURL (server-side test, bypasses CORS):</div>
                  <pre className="whitespace-pre-wrap break-all bg-white p-2 rounded border">{diag.curl}</pre>
                </div>
              </div>
            )}
            {error && (<div className="mt-4 p-4 rounded-lg bg-red-50 text-red-800">{error}</div>)}
          </form>

          {Array.isArray(results) && results.length > 0 && (() => {
            const row = results[0] || {};
            const sections = row['Tariff Section'] || [];
            const types = row['Tariff Type'] || [];
            const rates = row['Rate of Duty'] || [];
            const amounts = row['Tariff Amount'] || [];
            const finalDesc = (row['Final Description'] && row['Final Description'][0]) || 'â€”';

            const totalRate = rates.map(parsePercent).reduce((a, b) => a + b, 0);
            const totalDuty = amounts.map(parseMoney).reduce((a, b) => a + b, 0);
            const shipValNum = Number(formData.shipmentValue || 0);

            return (
              <section className="mt-10">
                {/* HTS Classification card */}
                <div className="bg-white border rounded-lg p-5">
                  <div className="flex items-center gap-2 text-sm text-gray-600 mb-2">
                    <span className="inline-flex items-center gap-1"><span className="w-2 h-2 bg-blue-600 inline-block rounded-full"/> HTS Classification</span>
                  </div>
                  <div className="text-gray-700 text-sm">{finalDesc}</div>

                  {/* Summary tiles */}
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div className="border rounded-lg p-4 bg-gray-50">
                      <div className="text-sm text-gray-500">Total Estimated Rate</div>
                      <div className="text-2xl font-semibold">{fmtPct(totalRate)}</div>
                    </div>
                    <div className="border rounded-lg p-4 bg-gray-50">
                      <div className="text-sm text-gray-500">Total Estimated Duty</div>
                      <div className="text-2xl font-semibold">{fmtUSD(totalDuty)}</div>
                    </div>
                    <div className="border rounded-lg p-4 bg-gray-50">
                      <div className="text-sm text-gray-500">Shipment value</div>
                      <div className="text-2xl font-semibold">{fmtUSD(shipValNum)}</div>
                    </div>
                  </div>

                  {/* Detailed Breakdown */}
                  <div className="mt-6">
                    <div className="flex items-center gap-2 text-sm text-gray-700 mb-2">
                      <span className="inline-flex items-center gap-1"><span className="w-3 h-3 inline-block border rounded"/> Detailed Tariff Breakdown</span>
                    </div>
                    <div className="overflow-x-auto">
                      <table className="min-w-full text-sm border">
                        <thead className="bg-blue-50">
                          <tr className="text-left text-gray-700">
                            <th className="p-2 border">TARIFF SELECTION</th>
                            <th className="p-2 border">TARIFF TYPE</th>
                            <th className="p-2 border">RATE</th>
                            <th className="p-2 border">EFFECTIVE RATE</th>
                            <th className="p-2 border">DUTY</th>
                          </tr>
                        </thead>
                        <tbody>
                          {sections.map((sec, i) => (
                            <tr key={`${sec}-${i}`} className="border-t">
                              <td className="p-2 border align-top">{sec || 'â€”'}</td>
                              <td className="p-2 border align-top">{types[i] || 'â€”'}</td>
                              <td className="p-2 border align-top">{rates[i] || 'â€”'}</td>
                              <td className="p-2 border align-top">{fmtPct(parsePercent(rates[i]))}</td>
                              <td className="p-2 border align-top">{amounts[i] || 'â€”'}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </section>
            );
          })()}
        </div>
      </main>

      {/* FAQs */}
      <section className="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <h2 className="text-3xl font-bold text-gray-900 mb-8">FAQs</h2>
        <div className="w-16 h-1 bg-blue-600 mb-8" />
        <div className="space-y-4">
          {faqs.map((faq, index) => (
            <div key={index} className="bg-white rounded-lg shadow">
              <button onClick={() => setOpenFaq(openFaq === index ? null : index)} className="w-full px-6 py-4 text-left flex justify-between items-center hover:bg-gray-50" aria-expanded={openFaq === index}>
                <span className="font-medium text-gray-900">{faq.question}</span>
                <IconChevronDown className={`w-5 h-5 text-gray-500 transition-transform ${openFaq === index ? 'rotate-180' : ''}`} />
              </button>
              {openFaq === index && (<div className="px-6 pb-4 text-gray-600">{faq.answer}</div>)}
            </div>
          ))}
        </div>
      </section>
    </div>
  );
}
